# ADR-001: Supabase RLS vs Custom Auth Middleware

## Status

**Accepted** — 2026-01-02

## Context

При разработке arbarea-mobile-app требовалось реализовать безопасную авторизацию и контроль доступа к данным. Основные варианты:

1. **Supabase Row Level Security (RLS)** — политики безопасности на уровне базы данных
2. **Custom Express Middleware** — ручная проверка прав в серверном коде
3. **Гибридный подход** — RLS + middleware для специфичных случаев

## Decision

Выбрана стратегия **Supabase RLS как основной механизм** с минимальным использованием `service_role` для привилегированных операций.

### Причины выбора:

1. **Безопасность по умолчанию** — данные защищены на уровне БД, даже если frontend-код содержит ошибки
2. **Единая точка контроля** — все правила в одном месте (SQL-политики), легко аудировать
3. **Производительность** — фильтрация происходит в БД, не нужно загружать лишние данные
4. **Простота frontend** — клиент просто делает запросы, RLS автоматически фильтрует результаты

### Ограничения:

- JWT-токен должен содержать `role` claim для admin-проверок
- `service_role` ключ используется только на сервере, никогда на клиенте
- Сложные бизнес-правила могут потребовать дополнительных проверок в коде

## Consequences

### Положительные:

- Невозможно случайно раскрыть чужие данные через frontend-баг
- Консистентные правила для всех клиентов (web, mobile, API)
- Проще тестировать безопасность (SQL-политики можно unit-тестировать)

### Отрицательные:

- Требует понимания PostgreSQL RLS синтаксиса
- Логирование/аудит требует отдельных триггеров (реализовано в миграции 002)
- Отладка RLS-ошибок сложнее, чем middleware

## Related Decisions

- ADR-002: Использование `anon` ключа для публичных данных (products)
- ADR-003: Аудит-логирование через триггеры
