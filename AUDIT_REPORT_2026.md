# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ ARBAREA

## 1. –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (Executive Summary)

–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ SPA –Ω–∞ –±–∞–∑–µ **React (Vite)** —Å –±—ç–∫–µ–Ω–¥–æ–º **Supabase** –∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ (Vercel/Express).

- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: üü¢ –•–æ—Ä–æ—à–∞—è. –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ UI, API –∏ –ë–î.
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: üü¢ –í—ã—Å–æ–∫–∞—è. RLS –≤–∫–ª—é—á–µ–Ω, –≤–µ–±—Ö—É–∫–∏ –∑–∞—â–∏—â–µ–Ω—ã –ø–æ–¥–ø–∏—Å—å—é.
- **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞**: üü° –°—Ä–µ–¥–Ω–µ–µ. –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ä—Ç–≤—ã–π/—Å–ª–æ–º–∞–Ω–Ω—ã–π –∫–æ–¥ (`api/auth-telegram.js`), –Ω–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ.

---

## 2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏ –±–∞–≥–∏

### üö® 1. –°–ª–æ–º–∞–Ω–Ω–∞—è Telegram-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Dead Code / Broken Architecture)

- **–§–∞–π–ª**: `api/auth-telegram.js`
- **–ü—Ä–æ–±–ª–µ–º–∞**:
  1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª: `import admin from './_firebase-admin.js'`. –≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –æ—à–∏–±–∫–µ **Runtime Error** –ø—Ä–∏ –≤—ã–∑–æ–≤–µ.
  2. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç**: –ü—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Firebase Admin SDK** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤, –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **Supabase**. –¢–æ–∫–µ–Ω—ã Firebase –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å —Å–µ—Å—Å–∏—è–º–∏ Supabase.
  3. **–§—Ä–æ–Ω—Ç–µ–Ω–¥**: –í `TelegramLoginButton.jsx` –∫–æ–¥ –≤—ã–∑–æ–≤–∞ API –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –£–¥–∞–ª–∏—Ç—å `api/auth-telegram.js`. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä Supabase (Telegram OAuth) –∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é Supabase JWT (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π –±–æ—Ç).

### ‚ö†Ô∏è 2. –ù–µ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –ª–æ–≥–∏–∫–∏ —Ñ–æ—Ä–º—ã –∑–∞–∫–∞–∑–æ–≤

- **–§–∞–π–ª**: `src/components/features/profile/IndividualOrderForm.jsx`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –õ–æ–≥–∏–∫–∞ "fall back" –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞ (`if table might be missing...`).
  - –ö–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å –≤ `individual_orders`. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –ø–∏—à–µ—Ç –≤ `orders`.
  - –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ —Å—Ö–µ–º–∞ –ë–î —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –£–±—Ä–∞—Ç—å "—Ñ–æ–ª–ª–±–µ–∫". –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã `individual_orders` —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏. –°—Ö–µ–º–∞ `schema.sql` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É, –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ.

### ‚ùì 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –ø–ª–∞—Ç–µ–∂–∞—Ö

- **–§–∞–π–ª**: `api/payment-webhook.js`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–±–æ–π –ë–î) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `200 OK`.
  - _–ü–ª—é—Å_: Tinkoff –Ω–µ –±—É–¥–µ—Ç "–¥–æ–ª–±–∏—Ç—å" –ø–æ–≤—Ç–æ—Ä–∞–º–∏, –µ—Å–ª–∏ —É –Ω–∞—Å –±–∞–≥.
  - _–ú–∏–Ω—É—Å_: –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ë–î –ª–µ–≥–ª–∞ –Ω–∞ —Å–µ–∫—É–Ω–¥—É), –º—ã –ø–æ—Ç–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã, –∏ –∑–∞–∫–∞–∑ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–º –¥–ª—è —Å–∏—Å—Ç–µ–º—ã.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –í–æ–∑–≤—Ä–∞—â–∞—Ç—å `500` –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤ (connection error), —á—Ç–æ–±—ã Tinkoff –ø–æ–≤—Ç–æ—Ä–∏–ª –∑–∞–ø—Ä–æ—Å, –∏ `200` —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ (–Ω–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å, –Ω–µ–≤–µ—Ä–Ω—ã–π ID), –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–≤—Ç–æ—Ä–æ–º –Ω–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å.

---

## 3. –ê—É–¥–∏—Ç –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Security Audit)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                  | –°—Ç–∞—Ç—É—Å      | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                                                        |
| -------------------------- | ----------- | -------------------------------------------------------------------------------------------------- |
| **Database RLS**           | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ | –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `profiles`, `products`, `orders` –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (User sees own, Admin sees all). |
| **Payments**               | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ | –ü—Ä–æ–≤–µ—Ä–∫–∞ `TerminalKey` –∏ –ø–æ–¥–ø–∏—Å–∏ (`SHA-256`) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–µ—Ä–Ω–æ.                                    |
| **Telegram Notifications** | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ | API `send-telegram` —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –°–ø–∞–º –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.                      |
| **API Webhooks**           | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ | CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.                                                                          |

---

## 4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é (Action Plan)

1. **–û—á–∏—Å—Ç–∫–∞**: –£–¥–∞–ª–∏—Ç—å `api/auth-telegram.js` –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ `firebase-admin` (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ package.json), —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.
2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –í `IndividualOrderForm.jsx` —É–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ (—Ñ–æ–ª–ª–±–µ–∫ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `orders`).
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –í `payment-webhook.js` –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é –æ—à–∏–±–æ–∫:
   - `Retryable Error` (DB connection) -> return 500.
   - `Fatal Error` (Signature, Validation) -> return 200.
4. **–°—Ö–µ–º–∞**: –ü—Ä–∏–º–µ–Ω–∏—Ç—å `supabase/schema.sql` (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞), —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–∂–Ω—ã–µ —Ñ–∏–∫—Å—ã (—Ñ–ª–∞–≥ `is_public` –∏ —Ç–∞–±–ª–∏—Ü–∞ `individual_orders`).

## 5. –ò—Ç–æ–≥ –∏ –°—Ç–∞—Ç—É—Å (Updated)

–ü—Ä–æ–µ–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–ª—è MVP. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥—ã—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (02.01.2026)

1.  üóë **Clean Up**: –£–¥–∞–ª–µ–Ω —Å–ª–æ–º–∞–Ω–Ω—ã–π —Ñ–∞–π–ª `api/auth-telegram.js`, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–ª —Å–±–æ–∏ –∏ —Å–æ–¥–µ—Ä–∂–∞–ª –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥.
2.  üõ† **Refactoring**: –õ–æ–≥–∏–∫–∞ `IndividualOrderForm.jsx` –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –£–¥–∞–ª–µ–Ω –Ω–µ–Ω–∞–¥–µ–∂–Ω—ã–π fallback-–º–µ—Ö–∞–Ω–∏–∑–º. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–∞—è —Å—Ö–µ–º–∞ –ë–î.
3.  üõ° **Reliability**: –í–µ–±—Ö—É–∫ –ø–ª–∞—Ç–µ–∂–µ–π (`api/payment-webhook.js`) —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500 –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –±–∞–Ω–∫–∞).

### üîú –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `individual_orders` —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ (–º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞).
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å flow –æ–ø–ª–∞—Ç—ã –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ UI.
