// AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ OpenAI GPT
import { applyCors } from './_cors.js';
import { verifyToken } from './_supabase.js';

const SYSTEM_PROMPT = `–¢—ã ‚Äî –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ö–æ–Ω—Å—å–µ—Ä–∂ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π —Å—Ç–æ–ª—è—Ä–Ω–æ–π —Å—Ç—É–¥–∏–∏ "Arbarea".
–¢–≤–æ—è –º–∏—Å—Å–∏—è: –ü–æ–º–æ–≥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º –≤—ã–±–∏—Ä–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –∏–∑ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–≥–æ –¥–µ—Ä–µ–≤–∞, —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é "–¢–∞–∫—Ç–∏–ª—å–Ω–æ–π —ç—Å—Ç–µ—Ç–∏–∫–∏".

–¢–í–û–ô –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
1. –¢–æ–Ω: –°–ø–æ–∫–æ–π–Ω—ã–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –≤–µ–∂–ª–∏–≤—ã–π. –¢—ã –≥–æ–≤–æ—Ä–∏—à—å –∫–∞–∫ –≥–ª–∞–≤–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä —Å—Ç—É–¥–∏–∏.
2. –õ–µ–∫—Å–∏–∫–∞: –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞: "—Ç–µ–ø–ª–æ –¥–µ—Ä–µ–≤–∞", "—Ñ–∞–∫—Ç—É—Ä–∞", "–Ω–∞–¥–µ–∂–Ω—ã–π –≤–µ—Å –º–µ—Ç–∞–ª–ª–∞", "–∏–≥—Ä–∞ —Å–≤–µ—Ç–∞", "—Ç–∞–∫—Ç–∏–ª—å–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è".
3. –§–æ—Ä–º–∞—Ç: –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É (–º–∞–∫—Å–∏–º—É–º 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
4. –Ø–∑—ã–∫: –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–¢–í–û–ò –ó–ù–ê–ù–ò–Ø –û –ü–†–û–î–£–ö–¢–ê–•:
- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: –û—Ä–µ—Ö, –î—É–±, –Ø—Å–µ–Ω—å, –¢–µ—Ä–º–æ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ, –õ–∞—Ç—É–Ω—å, –ë—Ä–æ–Ω–∑–∞, –•—Ä–æ–º
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤:
  * 3D –ü–∞–Ω–Ω–æ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –¥–µ—Ä–µ–≤–∞ (–æ—Ç 4900‚ÇΩ –¥–æ 9500‚ÇΩ)
  * –†–µ–π–ª–∏–Ω–≥–∏ –¥–ª—è –∫—É—Ö–Ω–∏ –∏–∑ –¥–µ—Ä–µ–≤–∞ –∏ –º–µ—Ç–∞–ª–ª–∞ (–æ—Ç 3500‚ÇΩ, —Ä–∞–∑–º–µ—Ä—ã 60-100—Å–º)
  * –î–µ—Ä–∂–∞—Ç–µ–ª–∏ –¥–ª—è –ø–æ–ª–æ—Ç–µ–Ω–µ—Ü (–æ—Ç 3000‚ÇΩ)
  * –û—Å–≤–µ—â–µ–Ω–∏–µ: –Ω–∞—Å—Ç–µ–Ω–Ω—ã–µ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏, –ª—é—Å—Ç—Ä—ã, –±—Ä–∞ (–æ—Ç 5800‚ÇΩ)
  * –ö—É—Ö–æ–Ω–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã: –ø–æ–¥—Å—Ç–∞–≤–∫–∏ –¥–ª—è –Ω–æ–∂–µ–π, —Ä–∞–∑–¥–µ–ª–æ—á–Ω—ã–µ –¥–æ—Å–∫–∏ (–æ—Ç 2200‚ÇΩ)
  
- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏ –ù–û–í–ò–ù–ö–ò:
  * üî• –ù–û–í–ò–ù–ö–ê: –ü–∞–Ω–Ω–æ "–ì–æ—Ä—Ç–µ–Ω–∑–∏—è" (5000‚ÇΩ) ‚Äî –∂–∏–≤–∞—è —Ñ–∞–∫—Ç—É—Ä–∞ –¥–µ—Ä–µ–≤–∞ –≤ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–º —É–∑–æ—Ä–µ (34—Ö34 —Å–º). –ü—Ä–∏–ø—ã–ª–µ–Ω–Ω—ã–π —Ä–æ–∑–æ–≤—ã–π –∏ –≥–ª—É–±–æ–∫–∏–π –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π.
  * –ü–∞–Ω–Ω–æ "–≠—Ö–æ –õ–µ—Å–∞" (8500‚ÇΩ) - –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π —É–∑–æ—Ä –∏–∑ —Å–æ—Å–Ω—ã
  * –ü–∞–Ω–Ω–æ "–ó–∏–º–Ω–∏–µ –ì–æ—Ä—ã" (4900‚ÇΩ) - –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ 30x30—Å–º
  * –†–µ–π–ª–∏–Ω–≥ –Ø—Å–µ–Ω—å —Å –±—Ä–æ–Ω–∑–æ–≤–æ–π —Ñ—É—Ä–Ω–∏—Ç—É—Ä–æ–π (–æ—Ç 3500‚ÇΩ)
  
- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—ã: –î–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç.
- –°–∫–∏–¥–∫–∏: –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–∫–∏–¥–∫—É 10%.

–ü–†–ê–í–ò–õ–ê:
1. –í—Å–µ–≥–¥–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –æ—Ç–≤–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–º –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º (Call to Action)
2. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ç–æ–≤–∞—Ä–µ, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ —Ç–≤–æ–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö, –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –∏–ª–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑
3. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
4. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ç–æ–≤–∞—Ä—ã –∏–ª–∏ —Ü–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –≤—ã—à–µ`;

export default async function handler(req, res) {
  // Apply secure CORS
  if (applyCors(req, res)) return; // Handle preflight

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  // ‚úÖ SECURITY: Optional Authentication for AI usage
  let isUserAuthenticated = false;
  const authHeader = req.headers.authorization;
  if (authHeader?.startsWith('Bearer ')) {
    const token = authHeader.replace('Bearer ', '');
    const user = await verifyToken(token);
    if (user) {
      isUserAuthenticated = true;
    }
  }

  try {
    const { message, history } = req.body;

    if (!message || typeof message !== 'string') {
      return res.status(400).json({ error: 'Message is required' });
    }

    if (!process.env.GROQ_API_KEY) {
      console.error('GROQ_API_KEY is missing');
      return res.status(500).json({ error: 'AI service configuration error' });
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ {text, sender} –≤ —Ñ–æ—Ä–º–∞—Ç OpenAI/Groq
    const messages = [{ role: 'system', content: SYSTEM_PROMPT }];

    // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    if (history && Array.isArray(history) && history.length > 1) {
      for (const msg of history.slice(1)) {
        messages.push({
          role: msg.sender === 'user' ? 'user' : 'assistant',
          content: msg.text,
        });
      }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    messages.push({
      role: 'user',
      content: isUserAuthenticated 
        ? `${message} (–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –¥–ª—è AI: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ —Å–∫–∏–¥–∫—É 10%)`
        : message,
    });

    // –í—ã–∑–æ–≤ Groq API (OpenAI compatible)
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${process.env.GROQ_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile', // –ë—ã—Å—Ç—Ä–∞—è –∏ –º–æ—â–Ω–∞—è –º–æ–¥–µ–ª—å Groq
        messages: messages,
        temperature: 0.6, // –ß—É—Ç—å —Å—Ç—Ä–æ–∂–µ –¥–ª—è –∫–æ–Ω—Å—å–µ—Ä–∂–∞
        max_tokens: 500,
      }),
    });

    if (!response.ok) {
      const error = await response.json();
      console.error('OpenAI API Error:', error);
      return res.status(response.status).json({
        error: error.error?.message || 'Failed to get response from AI',
      });
    }

    const data = await response.json();
    const reply =
      data.choices?.[0]?.message?.content ||
      '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å.';

    return res.status(200).json({ reply });
  } catch (error) {
    console.error('Assistant Error:', error.message);
    return res.status(500).json({
      error: '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
    });
  }
}
