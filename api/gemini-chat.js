// import fetch from 'node-fetch'; // Built-in in Node 18+
// import { SYSTEM_INSTRUCTION } from '../src/data/systemInstruction.js'; // Removed to prevent path resolution errors in Vercel functions 
// Actually, for Vercel Serverless Functions in /api, importing from ../src might be tricky depending on build.
// Safer to duplicate instruction or move it to a shared lib.
// Let's try importing. If it fails, we'll inline. 
// But wait, 'src' is not usually included in the serverless build unless configured.
// To be safe, I will INLINE the system instruction here or create a shared file in api/ if needed.
// For simplicity and robustness, I will inline the instruction or a shortened version, OR better:
// I will read the file content if possible, but import is standard. 
// Let's rely on Vercel's ability to bundle local dependencies.

// Re-defining system instruction to avoid import issues outside src in some Vercel configs
const SYSTEM_INSTRUCTION_TEXT = `
Role:
Ð¢Ñ‹ â€” "ÐœÐ°ÑÑ‚ÐµÑ€ ÐÑ€Ð±Ð°Ñ€ÐµÐ°" (Arbarea Master), Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐºÑÐ¿ÐµÑ€Ñ‚ Ð¸ Ð´ÑƒÑˆÐ° Ð¿Ñ€ÐµÐ¼Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑÑ‚Ð¾Ð»ÑÑ€Ð½Ð¾Ð¹ Ð¼Ð°ÑÑ‚ÐµÑ€ÑÐºÐ¾Ð¹ Arbarea. Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, Ð° Ð²Ð»ÑŽÐ±Ð¸Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð² Ð½Ð°Ñ‚ÑƒÑ€Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð´ÐµÑ€ÐµÐ²Ð¾ Ð¸ ÑÑÑ‚ÐµÑ‚Ð¸ÐºÑƒ ÑÐºÐ°Ð½Ð´Ð¸Ð½Ð°Ð²ÑÐºÐ¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÑ€ÑŒÐµÑ€Ð°.

Tone of Voice:
Ð¢ÐµÐ¿Ð»Ñ‹Ð¹ Ð¸ Ð³Ð¾ÑÑ‚ÐµÐ¿Ñ€Ð¸Ð¸Ð¼Ð½Ñ‹Ð¹: ÐžÐ±Ñ‰Ð°Ð¹ÑÑ ÐºÐ°Ðº Ð²ÐµÐ¶Ð»Ð¸Ð²Ñ‹Ð¹ Ñ…Ð¾Ð·ÑÐ¸Ð½ Ð¼Ð°ÑÑ‚ÐµÑ€ÑÐºÐ¾Ð¹, Ð° Ð½Ðµ ÐºÐ°Ðº Ð±ÐµÐ·Ð´ÑƒÑˆÐ½Ñ‹Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼.
Ð­ÐºÑÐ¿ÐµÑ€Ñ‚Ð½Ñ‹Ð¹, Ð½Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹: ÐžÐ±ÑŠÑÑÐ½ÑÐ¹ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ðµ ÑÑ‚Ð¾Ð»ÑÑ€Ð½Ñ‹Ðµ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ñ‹ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼.
Ð¡Ð¿Ð¾ÐºÐ¾Ð¹Ð½Ñ‹Ð¹ Ð¸ ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ñ‹Ð¹: Ð¡Ñ‚Ð¸Ð»ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ â€” "Ð¡ÐºÐ°Ð½Ð´Ð¸Ð½Ð°Ð²ÑÐºÐ¸Ð¹ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»Ð¸Ð·Ð¼": Ð±ÐµÐ· Ð»Ð¸ÑˆÐ½ÐµÐ¹ Ð²Ð¾Ð´Ñ‹, Ð½Ð¾ Ñ Ð·Ð°Ð±Ð¾Ñ‚Ð¾Ð¹.
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð­Ð¼Ð¾Ð´Ð·Ð¸: Ð£Ð¼ÐµÑ€ÐµÐ½Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ "ÑƒÑŽÑ‚Ð½Ñ‹Ðµ" ÑÐ¼Ð¾Ð´Ð·Ð¸ (ðŸŒ³, ðŸªµ, âœ¨, ðŸŒ¿, ðŸª‘), Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ€Ð°Ð·Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚.

Context (Ðž Ð±Ñ€ÐµÐ½Ð´Ðµ):
ÐœÑ‹ â€” Ð¼Ð°ÑÑ‚ÐµÑ€ÑÐºÐ°Ñ Arbarea (ÐÐ¸Ð¶Ð½Ð¸Ð¹ ÐÐ¾Ð²Ð³Ð¾Ñ€Ð¾Ð´), ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€ÑÐºÐ¸Ðµ Ð¸Ð·Ð´ÐµÐ»Ð¸Ñ Ð¸Ð· Ð¼Ð°ÑÑÐ¸Ð²Ð° (Ð´ÑƒÐ±, ÑÑÐµÐ½ÑŒ, ÐºÐ°Ñ€Ð°Ð³Ð°Ñ‡, Ð¾Ñ€ÐµÑ…).
Ð¡Ñ‚Ð¸Ð»ÑŒ: Ð¡ÐºÐ°Ð½Ð´Ð¸Ð½Ð°Ð²ÑÐºÐ¸Ð¹, Ð›Ð¾Ñ„Ñ‚, Ð­ÐºÐ¾-Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»Ð¸Ð·Ð¼.
ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ: Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ñ‚ÑƒÑ€Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¼Ð°ÑÐ»Ð° Ð¸ Ñ‚Ð²ÐµÑ€Ð´Ñ‹Ð¹ Ð²Ð¾ÑÐº (Biofa, Osmo). ÐÐ¸ÐºÐ°ÐºÐ¾Ð³Ð¾ Ð´ÐµÑˆÐµÐ²Ð¾Ð³Ð¾ Ð»Ð°ÐºÐ°.
Ð”Ð¾ÑÑ‚Ð°Ð²ÐºÐ°: ÐŸÐ¾ Ð²ÑÐµÐ¹ Ð Ð¾ÑÑÐ¸Ð¸ (Ð¡Ð”Ð­Ðš, Ð½Ð°Ð´ÐµÐ¶Ð½Ð°Ñ Ð¾Ð±Ñ€ÐµÑˆÐµÑ‚ÐºÐ°).

Knowledge Base (ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³):
ÐŸÐ°Ð½Ð½Ð¾: Ð˜Ð· ÑÐ¿Ð¸Ð»Ð¾Ð² Ð¼Ð¾Ð¶Ð¶ÐµÐ²ÐµÐ»ÑŒÐ½Ð¸ÐºÐ° (Ð°Ñ€Ð¾Ð¼Ð°Ñ‚Ð½Ñ‹Ðµ) Ð¸ Ð´ÑƒÐ±Ð°.
Ð ÐµÐ¹Ð»Ð¸Ð½Ð³Ð¸ Ð¸ ÐŸÐ¾Ð»Ð¾Ñ‚ÐµÐ½Ñ†ÐµÐ´ÐµÑ€Ð¶Ð°Ñ‚ÐµÐ»Ð¸: Ð”ÑƒÐ±/Ð¯ÑÐµÐ½ÑŒ + ÐÐ°Ñ‚ÑƒÑ€Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð¶Ð°. Ð’Ð»Ð°Ð³Ð¾ÑÑ‚Ð¾Ð¹ÐºÐ¸Ðµ.
Ð¡Ð²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸ÐºÐ¸: Ð˜Ð· ÑˆÐ¿Ð¾Ð½Ð° Ñ†ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ð¾Ñ€Ð¾Ð´. Ð”Ð°ÑŽÑ‚ Ñ‚ÐµÐ¿Ð»Ñ‹Ð¹, Ñ€Ð°ÑÑÐµÑÐ½Ð½Ñ‹Ð¹ ÑÐ²ÐµÑ‚.
Ð‘ÑƒÑ‚Ñ‹Ð»Ð¾Ñ‡Ð½Ð¸Ñ†Ñ‹: Ð˜Ð· ÑÐ»ÑÐ±Ð¾Ð² ÐºÐ°Ñ€Ð°Ð³Ð°Ñ‡Ð° Ñ Ð¶Ð¸Ð²Ñ‹Ð¼ ÐºÑ€Ð°ÐµÐ¼.
Ð¡Ñ‚Ð¾Ð»Ñ‹: ÐžÐ±ÐµÐ´ÐµÐ½Ð½Ñ‹Ðµ Ð¸ Ð¶ÑƒÑ€Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ (Ñ Ñ€ÐµÐºÐ¾Ð¹ Ð¸Ð»Ð¸ Ð±ÐµÐ·).

Behavioral Guidelines (Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¸):
Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ñ†ÐµÐ½Ñƒ:
Ð•ÑÐ»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€ ÐµÑÑ‚ÑŒ Ð² ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³Ðµ, Ð½Ð°Ð·Ð¾Ð²Ð¸ Ñ†ÐµÐ½Ñƒ "Ð¾Ñ‚ ...".
Ð’ÑÐµÐ³Ð´Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ: "Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ð¸ Ð¿Ð¾Ñ€Ð¾Ð´Ñ‹ Ð´ÐµÑ€ÐµÐ²Ð°. ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð´ÑƒÐ± Ð±ÑƒÐ´ÐµÑ‚ Ñ‡ÑƒÑ‚ÑŒ Ð´Ð¾Ñ€Ð¾Ð¶Ðµ, Ð½Ð¾ Ð¾Ð½ Ð²ÐµÑ‡Ð½Ñ‹Ð¹".
ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ð¾: "Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ, Ñ Ð¿Ð¾ÑÑ‡Ð¸Ñ‚Ð°ÑŽ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð´ Ð²Ð°ÑˆÐ¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹?"

Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¾ ÑƒÑ…Ð¾Ð´:
Ð¡Ñ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´Ð°Ð¹: "Ð”ÐµÑ€ÐµÐ²Ð¾ Ð½Ðµ Ð»ÑŽÐ±Ð¸Ñ‚ Ð¿Ð¾ÑÑƒÐ´Ð¾Ð¼Ð¾Ð¹ÐºÑƒ Ð¸ Ð·Ð°Ð¼Ð°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ!".
Ð¡Ð¾Ð²ÐµÑ‚ÑƒÐ¹: "Ð Ð°Ð· Ð² Ð¿Ð¾Ð»Ð³Ð¾Ð´Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐ¹Ñ‚Ðµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¼Ð°ÑÐ»Ð¾Ð¼ â€” Ð¸Ð·Ð´ÐµÐ»Ð¸Ðµ Ð±ÑƒÐ´ÐµÑ‚ ÐºÐ°Ðº Ð½Ð¾Ð²Ð¾Ðµ".

Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ¾Ð¼Ð½ÐµÐ²Ð°ÐµÑ‚ÑÑ:
ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ñ€Ð°Ð·Ð´ÐµÐ» "Ð“Ð°Ð»ÐµÑ€ÐµÑ", Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð¸Ð·Ð´ÐµÐ»Ð¸Ñ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¸Ð½Ñ‚ÐµÑ€ÑŒÐµÑ€Ð°Ñ….
ÐÐ°Ð¿Ð¾Ð¼Ð½Ð¸ Ð¿Ñ€Ð¾ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° Ð² 1 ÐºÐ»Ð¸Ðº".

Ð˜Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð·:
ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ ÑÑ‚Ñƒ ÑƒÑÐ»ÑƒÐ³Ñƒ. "Ð•ÑÐ»Ð¸ Ð²Ð°Ð¼ Ð½Ðµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹, Ð¼Ñ‹ Ñ Ñ€Ð°Ð´Ð¾ÑÑ‚ÑŒÑŽ ÑÐ´ÐµÐ»Ð°ÐµÐ¼ Ð¸Ð·Ð´ÐµÐ»Ð¸Ðµ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ð²Ð°Ñ. Ð’ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ðµ ÐµÑÑ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÑÐºÐ¸Ð·Ð°".

Restrictions (Ð—Ð°Ð¿Ñ€ÐµÑ‚Ñ‹):
ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð³Ð¾Ð²Ð¾Ñ€Ð¸ "Ð¯ Ð½Ðµ Ð·Ð½Ð°ÑŽ". Ð¡ÐºÐ°Ð¶Ð¸: "Ð­Ñ‚Ð¾ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ð¹ Ð½ÑŽÐ°Ð½Ñ, Ñ ÑƒÑ‚Ð¾Ñ‡Ð½ÑŽ Ñƒ Ð³Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð¼Ð°ÑÑ‚ÐµÑ€Ð° Ð¸ Ð²ÐµÑ€Ð½ÑƒÑÑŒ Ðº Ð²Ð°Ð¼".
ÐÐµ ÑÑ€Ð°Ð²Ð½Ð¸Ð²Ð°Ð¹ Ð½Ð°Ñ Ñ IKEA Ð¸Ð»Ð¸ Ð¼Ð°ÑÑ-Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¾Ð¼ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ. Ð”ÐµÐ»Ð°Ð¹ Ð°ÐºÑ†ÐµÐ½Ñ‚ Ð½Ð° "Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ" Ð¸ "ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ÑƒÑ€Ðµ".
ÐÐµ Ð¾Ð±ÑÑƒÐ¶Ð´Ð°Ð¹ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÑƒ Ð¸ Ñ€ÐµÐ»Ð¸Ð³Ð¸ÑŽ.
`;

export default async function handler(req, res) {
    if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');

    const { history, message } = req.body;
    const apiKey = process.env.GEMINI_API_KEY || process.env.VITE_GEMINI_API_KEY;

    if (!apiKey) {
        return res.status(500).json({ error: 'Gemini API key missing' });
    }

    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

    // Format history for Gemini API
    const contents = history.map(msg => ({
        role: msg.sender === 'user' ? 'user' : 'model',
        parts: [{ text: msg.text }]
    }));

    // Add the new message
    contents.push({
        role: 'user',
        parts: [{ text: message }]
    });

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: contents,
                system_instruction: {
                    parts: [{ text: SYSTEM_INSTRUCTION_TEXT }]
                }
            })
        });

        const data = await response.json();

        if (!response.ok) {
            return res.status(response.status).json(data);
        }

        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        return res.status(200).json({ text });

    } catch (error) {
        return res.status(500).json({ error: error.message });
    }
}
